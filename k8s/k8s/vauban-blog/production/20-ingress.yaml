apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vauban-blog
  namespace: vauban-blog
  labels:
    app: vauban-blog
    environment: production
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: vauban-blog-rate-limit@kubernetescrd,vauban-blog-security-headers@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - bastion.vauban.tech
      secretName: vauban-blog-tls
  rules:
    - host: bastion.vauban.tech
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-active  # Points to active deployment
                port:
                  number: 3000
---
# Preview ingress (for testing new deployments before promotion)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vauban-blog-preview
  namespace: vauban-blog
  labels:
    app: vauban-blog
    role: preview
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - preview.bastion.vauban.tech
      secretName: vauban-blog-preview-tls
  rules:
    - host: preview.bastion.vauban.tech
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-preview  # Points to preview (green) deployment
                port:
                  number: 3000
---
# Rate limiting middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: vauban-blog
spec:
  rateLimit:
    average: 200
    burst: 400
    period: 1m
---
# Security headers middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: vauban-blog
spec:
  headers:
    frameDeny: true
    contentTypeNosniff: true
    browserXssFilter: true
    referrerPolicy: "strict-origin-when-cross-origin"
    customResponseHeaders:
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"
---
# IPFS Gateway ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ipfs-gateway
  namespace: vauban-blog
  labels:
    app: vauban-blog
    component: ipfs
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - ipfs.vauban.tech
      secretName: ipfs-vauban-tls
  rules:
    - host: ipfs.vauban.tech
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ipfs
                port:
                  number: 8080
